---
import ImageCarousel from '../widgets/ImageCarousel.astro';
import { getImage } from 'astro:assets';

// Get all images from the trilocale directory
const imageModules = await Astro.glob('../../assets/images/trilocale/*.webp');

// Generate optimized responsive images
const images = await Promise.all(
  imageModules.map(async (module, index) => {
    const originalImage = module.default;
    
    // Generate thumbnail variants (for carousel)
    const thumbnail400 = await getImage({
      src: originalImage,
      width: 400,
      format: 'webp',
      quality: 80,
    });
    
    const thumbnail800 = await getImage({
      src: originalImage,
      width: 800,
      format: 'webp',
      quality: 85,
    });
    
    const thumbnail1200 = await getImage({
      src: originalImage,
      width: 1200,
      format: 'webp',
      quality: 85,
    });
    
    // Generate full-size variants (for modal)
    const full1600 = await getImage({
      src: originalImage,
      width: 1600,
      format: 'webp',
      quality: 90,
    });
    
    const full2400 = await getImage({
      src: originalImage,
      width: 2400,
      format: 'webp',
      quality: 90,
    });
    
    return {
      // Thumbnail srcset for carousel view
      src: thumbnail800.src,
      srcset: `${thumbnail400.src} 400w, ${thumbnail800.src} 800w, ${thumbnail1200.src} 1200w`,
      sizes: '(max-width: 768px) 100vw, 50vw',
      
      // Full-size srcset for modal view
      fullSrc: full1600.src,
      fullSrcset: `${thumbnail1200.src} 1200w, ${full1600.src} 1600w, ${full2400.src} 2400w`,
      
      alt: `Trilocale apartment view ${index + 1}`,
      title: `Image ${index + 1} of trilocale apartment`,
    };
  })
);
---

<div class="flex flex-col-reverse lg:flex-row gap-6 lg:gap-12 max-w-7xl mx-auto px-4 py-6 sm:px-6 lg:px-8">
  <!-- Image carousel section -->
  <div class="w-full lg:w-1/2 flex flex-col gap-4 lg:gap-6">
    <div 
      class="carousel-container" 
      data-carousel-deferred
    >
      <ImageCarousel 
        images={images} 
        loading="lazy" 
        preloadCount={1}
      />
    </div>
  </div>

  <!-- Apartment information -->
  <div class="w-full lg:w-1/2 space-y-6 lg:space-y-8">
    <!-- Titles -->
    <div class="space-y-1 lg:space-y-2">
      <h1 class="text-2xl sm:text-3xl font-bold">Ampio Trilocale:</h1>
      <h2 class="text-xl sm:text-2xl text-gray-700">2 camere e 2 bagni</h2>
    </div>

    <!-- Description -->
    <div class="space-y-3">
      <div class="flex items-center gap-2">
        <div class="w-5 h-5 sm:w-6 sm:h-6 rounded-full bg-green-500 flex items-center justify-center flex-shrink-0">
          <svg class="w-3 h-3 sm:w-4 sm:h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
          </svg>
        </div>
        <h3 class="text-lg sm:text-xl font-medium">Descrizione:</h3>
      </div>
      <p class="text-sm sm:text-base text-gray-700 leading-relaxed">
        L'appartamento offre due camere (una matrimoniale e una con due letti singoli), due bagni (uno con doccia) e un
        soggiorno con cucina ben fornita. Perfetto per famiglie o gruppi di amici che desiderano maggiore spazio e
        comfort.
      </p>
    </div>

    <!-- Surface area -->
    <div class="space-y-3">
      <div class="flex items-center gap-2">
        <div class="w-5 h-5 sm:w-6 sm:h-6 rounded-full bg-green-500 flex items-center justify-center flex-shrink-0">
          <svg class="w-3 h-3 sm:w-4 sm:h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M4 8V4m0 0h4M4 4l5 5m11-2V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path>
          </svg>
        </div>
        <h3 class="text-lg sm:text-xl font-medium">Superficie:</h3>
      </div>
      <p class="text-sm sm:text-base text-gray-700">120 mq</p>
    </div>

    <!-- Capacity -->
    <div class="space-y-3">
      <div class="flex items-center gap-2">
        <div class="w-5 h-5 sm:w-6 sm:h-6 rounded-full bg-green-500 flex items-center justify-center flex-shrink-0">
          <svg class="w-3 h-3 sm:w-4 sm:h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14c-2.67 0-8 1.34-8 4v3h16v-3c0-2.66-5.33-4-8-4z"></path>
          </svg>
        </div>
        <h3 class="text-lg sm:text-xl font-medium">Capacit√†:</h3>
      </div>
      <p class="text-sm sm:text-base text-gray-700">4 ospiti</p>
    </div>
  </div>
</div>

<!-- Deferred initialization script -->
<script>
  function initCarousel() {
    const carouselContainer = document.querySelector('[data-carousel-deferred]');
    if (!carouselContainer) return;

    if ('IntersectionObserver' in window) {
      const observer = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              carouselContainer.removeAttribute('data-carousel-deferred');
              observer.disconnect();
            }
          });
        },
        {
          rootMargin: '50px',
          threshold: 0.01
        }
      );

      observer.observe(carouselContainer);
    } else {
      carouselContainer.removeAttribute('data-carousel-deferred');
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initCarousel);
  } else {
    initCarousel();
  }
</script>

<style>
  .carousel-container[data-carousel-deferred] {
    background: linear-gradient(90deg, #f0f0f0 0%, #f8f8f8 50%, #f0f0f0 100%);
    background-size: 200% 100%;
    animation: shimmer 1.5s ease-in-out infinite;
    border-radius: 0.5rem;
  }

  @keyframes shimmer {
    0% { background-position: -200% 0; }
    100% { background-position: 200% 0; }
  }

  .carousel-container:not([data-carousel-deferred]) {
    animation: none;
    background: transparent;
  }
</style>